name: CI

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true

jobs:
  static:
    if: ${{ hashFiles('package.json') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Static quality checks
        run: |
          npm run lint
          npm run typecheck
          npm run format:check
          npm run depcheck
          npm audit --audit-level=high

  build:
    if: ${{ hashFiles('package.json') != '' }}
    needs: static
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build

  test-unit-int:
    if: ${{ hashFiles('package.json') != '' }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Unit & integration tests
        run: npm run test:unit

  test-api-contract:
    if: ${{ hashFiles('package.json') != '' }}
    needs: test-unit-int
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: API contract tests
        run: npm run test:api

  test-e2e:
    if: ${{ hashFiles('package.json') != '' }}
    needs: test-api-contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: E2E tests
        run: npm run test:e2e
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/**
            test-results/**
          if-no-files-found: ignore

  visual-regression:
    if: ${{ hashFiles('package.json') != '' }}
    needs: test-e2e
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Visual regression tests
        run: npm run test:visual
      - name: Upload visual screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-screenshots
          path: |
            tests/visual/**
            playwright-report/**
          if-no-files-found: ignore

  a11y-i18n:
    if: ${{ hashFiles('package.json') != '' }}
    needs: visual-regression
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Accessibility & i18n tests
        run: npm run test:a11y

  perf:
    if: ${{ hashFiles('package.json') != '' }}
    needs: a11y-i18n
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Performance (Lighthouse CI)
        run: npm run test:perf
      - name: Upload Lighthouse report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse
          path: |
            ./.lighthouseci/**
            ./lighthouse/**
          if-no-files-found: ignore

  quality-gate:
    if: ${{ hashFiles('package.json') != '' }}
    needs: [perf]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate Quality Gate Report
        run: |
          if [ -f scripts/ci/quality-gate.sh ]; then
            bash scripts/ci/quality-gate.sh
          else
            echo "# Quality Gate Report" > quality-gate-report.md
            echo "This is a placeholder. Project-specific aggregator can overwrite this." >> quality-gate-report.md
          fi
      - name: Upload Quality Gate Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-report
          path: quality-gate-report.md

